<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>proposal</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #2a211c;
        color: #bdae9d;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
    div.sourceCode
      { color: #bdae9d; background-color: #2a211c; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ffff00; } /* Alert */
    code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { } /* Attribute */
    code span.bn { color: #44aa43; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #049b0a; } /* Char */
    code span.cn { } /* Constant */
    code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
    code span.do { color: #0066ff; font-style: italic; } /* Documentation */
    code span.dt { text-decoration: underline; } /* DataType */
    code span.dv { color: #44aa43; } /* DecVal */
    code span.er { color: #ffff00; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #44aa43; } /* Float */
    code span.fu { color: #ff9358; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
    code span.op { } /* Operator */
    code span.pp { font-weight: bold; } /* Preprocessor */
    code span.sc { color: #049b0a; } /* SpecialChar */
    code span.ss { color: #049b0a; } /* SpecialString */
    code span.st { color: #049b0a; } /* String */
    code span.va { } /* Variable */
    code span.vs { color: #049b0a; } /* VerbatimString */
    code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
</head>
<body>
<h2
id="utilizing-stellar-blockchain-and-soroban-smart-contracts-for-library-ebook-lending">Utilizing
Stellar Blockchain and Soroban Smart Contracts for Library eBook
Lending</h2>
<h3 id="introduction">Introduction</h3>
<p>In the digital age, libraries face the challenge of managing digital
assets and intellectual property rights efficiently while ensuring that
eBooks are accessible to users in a secure manner. Blockchain
technology, with its inherent security and transparency, offers a
solution to these challenges. By leveraging the Stellar blockchain and
Soroban smart contracts, we can create a system for managing eBook
lending that ensures only one person can read an eBook at a time and
that access is revoked once the lending period ends.</p>
<h3 id="objectives">Objectives</h3>
<ol type="1">
<li>Develop a system to manage eBook lending using Stellar
blockchain.</li>
<li>Ensure that eBooks can only be checked out by one person at a
time.</li>
<li>Revoke access to eBooks once they are returned or the lending period
expires.</li>
<li>Utilize Soroban smart contracts to automate and secure the lending
process.</li>
</ol>
<h3 id="technical-implementation">Technical Implementation</h3>
<h4
id="step-1-add-an-asset-book-with-custom-boolean-property-ischeckedout-and-address-property-checkedoutby">Step
1: Add an Asset (Book) with Custom Boolean Property
<code>isCheckedOut</code> and Address Property
<code>checkedOutBy</code></h4>
<p>We first create an asset on the Stellar network representing the book
and add custom properties to track its lending status.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { Keypair<span class="op">,</span> <span class="bu">Server</span><span class="op">,</span> TransactionBuilder<span class="op">,</span> Operation<span class="op">,</span> Asset<span class="op">,</span> Networks } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;stellar-sdk&#39;</span>)<span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fetch <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;node-fetch&#39;</span>)<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Set up the Stellar server</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="kw">new</span> <span class="bu">Server</span>(<span class="st">&#39;https://horizon-testnet.stellar.org&#39;</span>)<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Generate a keypair for the issuing account</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> issuingKeypair <span class="op">=</span> Keypair<span class="op">.</span><span class="fu">random</span>()<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a new asset representing the book</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bookAsset <span class="op">=</span> <span class="kw">new</span> <span class="fu">Asset</span>(<span class="st">&#39;BookToken&#39;</span><span class="op">,</span> issuingKeypair<span class="op">.</span><span class="fu">publicKey</span>())<span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to create the asset and set the custom properties</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">createBookAsset</span>() {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fund the issuing account</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`https://friendbot.stellar.org?addr=</span><span class="sc">${</span>issuingKeypair<span class="op">.</span><span class="fu">publicKey</span>()<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load the issuing account</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> account <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">loadAccount</span>(issuingKeypair<span class="op">.</span><span class="fu">publicKey</span>())<span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create the transaction to issue the asset and set the custom properties</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> transaction <span class="op">=</span> <span class="kw">new</span> <span class="fu">TransactionBuilder</span>(account<span class="op">,</span> {</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fee</span><span class="op">:</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">fetchBaseFee</span>()<span class="op">,</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">networkPassphrase</span><span class="op">:</span> Networks<span class="op">.</span><span class="at">TESTNET</span><span class="op">,</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addOperation</span>(Operation<span class="op">.</span><span class="fu">changeTrust</span>({</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>            <span class="dt">asset</span><span class="op">:</span> bookAsset<span class="op">,</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>            <span class="dt">source</span><span class="op">:</span> issuingKeypair<span class="op">.</span><span class="fu">publicKey</span>()<span class="op">,</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addOperation</span>(Operation<span class="op">.</span><span class="fu">payment</span>({</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>            <span class="dt">destination</span><span class="op">:</span> issuingKeypair<span class="op">.</span><span class="fu">publicKey</span>()<span class="op">,</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>            <span class="dt">asset</span><span class="op">:</span> bookAsset<span class="op">,</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>            <span class="dt">amount</span><span class="op">:</span> <span class="st">&#39;0.0000001&#39;</span><span class="op">,</span> <span class="co">// Minimum amount to create the asset</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addOperation</span>(Operation<span class="op">.</span><span class="fu">manageData</span>({</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>            <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;isCheckedOut&#39;</span><span class="op">,</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>            <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;false&#39;</span><span class="op">,</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            <span class="dt">source</span><span class="op">:</span> issuingKeypair<span class="op">.</span><span class="fu">publicKey</span>()<span class="op">,</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addOperation</span>(Operation<span class="op">.</span><span class="fu">manageData</span>({</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>            <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;checkedOutBy&#39;</span><span class="op">,</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>            <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>            <span class="dt">source</span><span class="op">:</span> issuingKeypair<span class="op">.</span><span class="fu">publicKey</span>()<span class="op">,</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">setTimeout</span>(<span class="dv">100</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span>()<span class="op">;</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sign and submit the transaction</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    transaction<span class="op">.</span><span class="fu">sign</span>(issuingKeypair)<span class="op">;</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> server<span class="op">.</span><span class="fu">submitTransaction</span>(transaction)<span class="op">;</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Book asset created with isCheckedOut and checkedOutBy properties set&#39;</span>)<span class="op">;</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="fu">createBookAsset</span>()<span class="op">;</span></span></code></pre></div>
<h4
id="step-2-create-a-soroban-smart-contract-to-manage-the-ischeckedout-property-and-store-the-request-sender-address">Step
2: Create a Soroban Smart Contract to Manage the
<code>isCheckedOut</code> Property and Store the Request Sender
Address</h4>
<p>We then create a Soroban smart contract to manage the
<code>isCheckedOut</code> property of the book asset and store the
address of the request sender.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">soroban_sdk::</span><span class="op">{</span>contractimpl<span class="op">,</span> Env<span class="op">,</span> Symbol<span class="op">,</span> Address<span class="op">,</span> Bytes<span class="op">,</span> BytesN<span class="op">,</span> Timestamp<span class="op">};</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> LibraryContract<span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>contractimpl<span class="at">]</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> LibraryContract <span class="op">{</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> check_out_book(env<span class="op">:</span> Env<span class="op">,</span> book_id<span class="op">:</span> Symbol<span class="op">,</span> user<span class="op">:</span> Address<span class="op">,</span> return_date<span class="op">:</span> Timestamp) <span class="op">-&gt;</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> is_checked_out <span class="op">=</span> env<span class="op">.</span>storage()<span class="op">.</span>has(<span class="op">&amp;</span>book_id)<span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> is_checked_out <span class="op">{</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> checked_out_status<span class="op">:</span> <span class="dt">bool</span> <span class="op">=</span> env<span class="op">.</span>storage()<span class="op">.</span>get(<span class="op">&amp;</span>book_id)<span class="op">.</span>unwrap()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> checked_out_status <span class="op">{</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                <span class="pp">panic!</span>(<span class="st">&quot;Book is already checked out&quot;</span>)<span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update the status to checked out</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        env<span class="op">.</span>storage()<span class="op">.</span>set(<span class="op">&amp;</span>book_id<span class="op">,</span> <span class="op">&amp;</span><span class="cn">true</span>)<span class="op">;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store the address of the user who checked out the book</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> checked_out_by_key <span class="op">=</span> <span class="pp">Symbol::</span>from_str(<span class="st">&quot;checkedOutBy&quot;</span>)<span class="op">;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        env<span class="op">.</span>storage()<span class="op">.</span>set(<span class="op">&amp;</span>checked_out_by_key<span class="op">,</span> <span class="op">&amp;</span>user)<span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store the return date</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> return_date_key <span class="op">=</span> <span class="pp">Symbol::</span>from_str(<span class="st">&quot;returnDate&quot;</span>)<span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        env<span class="op">.</span>storage()<span class="op">.</span>set(<span class="op">&amp;</span>return_date_key<span class="op">,</span> <span class="op">&amp;</span>return_date)<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generate a new token (e.g., a unique identifier for this checkout session)</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_token <span class="op">=</span> env<span class="op">.</span>random()<span class="op">.</span>generate()<span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> token_key <span class="op">=</span> <span class="pp">Symbol::</span>from_str(<span class="st">&quot;checkoutToken&quot;</span>)<span class="op">;</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        env<span class="op">.</span>storage()<span class="op">.</span>set(<span class="op">&amp;</span>token_key<span class="op">,</span> <span class="op">&amp;</span>new_token)<span class="op">;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        new_token</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> return_book(env<span class="op">:</span> Env<span class="op">,</span> book_id<span class="op">:</span> Symbol<span class="op">,</span> user<span class="op">:</span> Address) <span class="op">{</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> is_checked_out <span class="op">=</span> env<span class="op">.</span>storage()<span class="op">.</span>has(<span class="op">&amp;</span>book_id)<span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>is_checked_out <span class="op">{</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>            <span class="pp">panic!</span>(<span class="st">&quot;Book does not exist&quot;</span>)<span class="op">;</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> checked_out_status<span class="op">:</span> <span class="dt">bool</span> <span class="op">=</span> env<span class="op">.</span>storage()<span class="op">.</span>get(<span class="op">&amp;</span>book_id)<span class="op">.</span>unwrap()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>checked_out_status <span class="op">{</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            <span class="pp">panic!</span>(<span class="st">&quot;Book is already returned&quot;</span>)<span class="op">;</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify the user returning the book</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> checked_out_by_key <span class="op">=</span> <span class="pp">Symbol::</span>from_str(<span class="st">&quot;checkedOutBy&quot;</span>)<span class="op">;</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> stored_user<span class="op">:</span> Address <span class="op">=</span> env<span class="op">.</span>storage()<span class="op">.</span>get(<span class="op">&amp;</span>checked_out_by_key)<span class="op">.</span>unwrap()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stored_user <span class="op">!=</span> user <span class="op">{</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>            <span class="pp">panic!</span>(<span class="st">&quot;Unauthorized return&quot;</span>)<span class="op">;</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update the status to returned</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        env<span class="op">.</span>storage()<span class="op">.</span>set(<span class="op">&amp;</span>book_id<span class="op">,</span> <span class="op">&amp;</span><span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear the checkout token</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> token_key <span class="op">=</span> <span class="pp">Symbol::</span>from_str(<span class="st">&quot;checkoutToken&quot;</span>)<span class="op">;</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        env<span class="op">.</span>storage()<span class="op">.</span>remove(<span class="op">&amp;</span>token_key)<span class="op">;</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> verify_token(env<span class="op">:</span> Env<span class="op">,</span> token<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> token_key <span class="op">=</span> <span class="pp">Symbol::</span>from_str(<span class="st">&quot;checkoutToken&quot;</span>)<span class="op">;</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> stored_token<span class="op">:</span> BytesN<span class="op">&lt;</span><span class="dv">32</span><span class="op">&gt;</span> <span class="op">=</span> env<span class="op">.</span>storage()<span class="op">.</span>get(<span class="op">&amp;</span>token_key)<span class="op">.</span>unwrap()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>        stored_token <span class="op">==</span> token</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> invalidate_token(env<span class="op">:</span> Env<span class="op">,</span> book_id<span class="op">:</span> Symbol) <span class="op">{</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> return_date_key <span class="op">=</span> <span class="pp">Symbol::</span>from_str(<span class="st">&quot;returnDate&quot;</span>)<span class="op">;</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> stored_return_date<span class="op">:</span> Timestamp <span class="op">=</span> env<span class="op">.</span>storage()<span class="op">.</span>get(<span class="op">&amp;</span>return_date_key)<span class="op">.</span>unwrap()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> env<span class="op">.</span>now() <span class="op">&gt;</span> stored_return_date <span class="op">{</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update the status to returned</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>            env<span class="op">.</span>storage()<span class="op">.</span>set(<span class="op">&amp;</span>book_id<span class="op">,</span> <span class="op">&amp;</span><span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Clear the checkout token</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> token_key <span class="op">=</span> <span class="pp">Symbol::</span>from_str(<span class="st">&quot;checkoutToken&quot;</span>)<span class="op">;</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>            env<span class="op">.</span>storage()<span class="op">.</span>remove(<span class="op">&amp;</span>token_key)<span class="op">;</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="step-3-encrypt-the-ebook-with-the-generated-token">Step 3:
Encrypt the eBook with the Generated Token</h3>
<p>We use the generated token to encrypt the eBook. This ensures that
only the user with the valid token can decrypt and read the eBook.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> crypto <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;crypto&#39;</span>)<span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Encrypt the eBook</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">encryptEBook</span>(eBookContent<span class="op">,</span> token) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> algorithm <span class="op">=</span> <span class="st">&#39;aes-256-ctr&#39;</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cipher <span class="op">=</span> crypto<span class="op">.</span><span class="fu">createCipheriv</span>(algorithm<span class="op">,</span> token<span class="op">,</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">alloc</span>(<span class="dv">16</span><span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> encrypted <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">concat</span>([cipher<span class="op">.</span><span class="fu">update</span>(eBookContent)<span class="op">,</span> cipher<span class="op">.</span><span class="fu">final</span>()])<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> encrypted<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Decrypt the eBook</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">decryptEBook</span>(encryptedEBook<span class="op">,</span> token) {</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> algorithm <span class="op">=</span> <span class="st">&#39;aes-256-ctr&#39;</span><span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> decipher <span class="op">=</span> crypto<span class="op">.</span><span class="fu">createDecipheriv</span>(algorithm<span class="op">,</span> token<span class="op">,</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">alloc</span>(<span class="dv">16</span><span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> decrypted <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">concat</span>([decipher<span class="op">.</span><span class="fu">update</span>(encryptedEBook)<span class="op">,</span> decipher<span class="op">.</span><span class="fu">final</span>()])<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> decrypted<span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Example usage</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> eBookContent <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">from</span>(<span class="st">&#39;This is the content of the eBook&#39;</span>)<span class="op">;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> token <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomBytes</span>(<span class="dv">32</span>)<span class="op">;</span> <span class="co">// This should be the token generated by the smart contract</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> encryptedEBook <span class="op">=</span> <span class="fu">encryptEBook</span>(eBookContent<span class="op">,</span> token)<span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Encrypted eBook:&#39;</span><span class="op">,</span> encryptedEBook)<span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> decryptedEBook <span class="op">=</span> <span class="fu">decryptEBook</span>(encryptedEBook<span class="op">,</span> token)<span class="op">;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Decrypted eBook:&#39;</span><span class="op">,</span> decryptedEBook<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span></code></pre></div>
<h3 id="step-4-integrate-with-the-smart-contract">Step 4: Integrate with
the Smart Contract</h3>
<ol type="1">
<li><strong>Checkout</strong>:
<ul>
<li>Call the <code>check_out_book</code> function to get the token.</li>
<li>Use the token to encrypt the eBook.</li>
</ul></li>
<li><strong>Return</strong>:
<ul>
<li>Call the <code>return_book</code> function to invalidate the
token.</li>
</ul></li>
<li><strong>Verification</strong>:
<ul>
<li>Call the <code>verify_token</code> function to check if the token is
valid before allowing the user to decrypt and read the eBook.</li>
</ul></li>
<li><strong>Auto-Invalidate</strong>:
<ul>
<li>Periodically call the <code>invalidate_token</code> function to
check if the return date has passed and invalidate the token if
necessary.</li>
</ul></li>
</ol>
<h3 id="conclusion">Conclusion</h3>
<p>By leveraging the Stellar blockchain and Soroban smart contracts, we
can create a secure and efficient system for managing eBook lending in
libraries. This system ensures that only one person can read an eBook at
a time, and access is revoked once the book is returned or the lending
period expires. This approach not only enhances the security and
transparency of the lending process but also aligns with the goals of
preserving intellectual property rights and providing seamless access to
digital resources.</p>
<h3 id="proposed-work">Proposed Work</h3>
<p>Proposed work will involve:</p>
<ol type="1">
<li>Implementing and deploying Checkout contract</li>
<li>Working with an existing library to import assets (physical and/or
digital)</li>
<li>Test and fine-tune the blockchain-based checkout process</li>
</ol>
<p>The library I had in mind for testing purposes is the <a
href="https://internetarchive.org">Internet Archive</a> as they have an
outstanding collection of books, both physical as well as scanned
ebooks. The Internet Archive has been in the news recently due to being
sued by publishers for over-loaning scanned books.</p>
<h3 id="future-work">Future Work</h3>
<p>Future work could involve:</p>
<ol type="1">
<li>Integrate the system with existing library management software.</li>
<li>Developing user-friendly interfaces for library staff and
patrons.</li>
<li>Implementing additional features such as notifications for overdue
books and automated extensions.</li>
</ol>
<p>This proposal aims to leverage cutting-edge blockchain technology to
modernize library operations and improve the accessibility and security
of digital resources. We look forward to the opportunity to implement
and demonstrate this innovative solution.</p>
</body>
</html>
